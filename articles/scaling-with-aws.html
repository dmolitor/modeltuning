<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Scaling with AWS • modeltuning</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Scaling with AWS">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">modeltuning</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basic-usage.html">Basic usage</a></li>
    <li><a class="dropdown-item" href="../articles/data-masking.html">Data masking</a></li>
    <li><a class="dropdown-item" href="../articles/scaling-with-aws.html">Scaling with AWS</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Scaling with AWS</h1>
            
      

      <div class="d-none name"><code>scaling-with-aws.Rmd</code></div>
    </div>

    
    
<p>This vignette will walk through an example of scaling a
<code>modeltuning</code> analysis with AWS via the <a href="https://github.com/paws-r/paws" class="external-link">Paws SDK</a>. The following
analysis depends on AWS credentials passed via environment variables. To
see a detailed outline of the different ways to set AWS credentials,
check out <a href="https://github.com/paws-r/paws/blob/main/docs/credentials.md" class="external-link">this
how-to document</a>.</p>
<div class="section level2">
<h2 id="requisite-packages">Requisite Packages<a class="anchor" aria-label="anchor" href="#requisite-packages"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">e1071</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.dmolitor.com/modeltuning/" class="external-link">modeltuning</a></span><span class="op">)</span> <span class="co"># devtools::install_github("dmolitor/modeltuning")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://parallelly.futureverse.org" class="external-link">parallelly</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paws-r/paws" class="external-link">paws</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org" class="external-link">rsample</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/yardstick" class="external-link">yardstick</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-and-model-prep">Data and Model Prep<a class="anchor" aria-label="anchor" href="#data-and-model-prep"></a>
</h2>
<div class="section level3">
<h3 id="data-prep">Data Prep<a class="anchor" aria-label="anchor" href="#data-prep"></a>
</h3>
<p>We’ll be training a classification model on the <code>iris</code>
data-set to predict whether a flower’s species is virginica or not.</p>
<p>First, let’s generate a bunch of synthetic data observations by
adding random noise to the original <code>iris</code> features and
combining it into one big dataframe.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  what <span class="op">=</span> <span class="va">rbind</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span>, <span class="va">iris</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span></span>
<span>    Sepal.Length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    Sepal.Width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">Sepal.Width</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    Petal.Length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">Petal.Length</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    Petal.Width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/jitter.html" class="external-link">jitter</a></span><span class="op">(</span><span class="va">Petal.Width</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    Species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">==</span> <span class="st">"virginica"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Shuffle the data-set</span></span>
<span><span class="va">iris_new</span> <span class="op">&lt;-</span> <span class="va">iris_new</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris_new</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris_new</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Quick overview of the dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">iris_new</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#   Sepal.Length    Sepal.Width     Petal.Length     Petal.Width     </span></span>
<span><span class="co">#  Min.   :4.299   Min.   :1.999   Min.   :0.9986   Min.   :0.09801  </span></span>
<span><span class="co">#  1st Qu.:5.101   1st Qu.:2.799   1st Qu.:1.5984   1st Qu.:0.29972  </span></span>
<span><span class="co">#  Median :5.799   Median :3.001   Median :4.3499   Median :1.30126  </span></span>
<span><span class="co">#  Mean   :5.843   Mean   :3.057   Mean   :3.7580   Mean   :1.19938  </span></span>
<span><span class="co">#  3rd Qu.:6.400   3rd Qu.:3.302   3rd Qu.:5.1002   3rd Qu.:1.80059  </span></span>
<span><span class="co">#  Max.   :7.901   Max.   :4.401   Max.   :6.9020   Max.   :2.50193</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="grid-search-specification">Grid Search Specification<a class="anchor" aria-label="anchor" href="#grid-search-specification"></a>
</h3>
<p>Now that we’ve got the data prepped, let’s specify our predictive
modeling approach. For this analysis I’m going to train a Support Vector
classifier using the <code>e1071</code> package, and I’m going to use
Grid Search in combination with 5-fold Cross-Validation to find the
optimal values for the <code>cost</code> and <code>kernel</code>
hyper-parameters.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a splitter function that will return CV folds</span></span>
<span><span class="va">splitter_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html" class="external-link">vfold_cv</a></span><span class="op">(</span><span class="va">data</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">$</span><span class="va">splits</span>, \<span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="va">y</span><span class="op">$</span><span class="va">in_id</span><span class="op">)</span></span>
<span></span>
<span><span class="va">iris_grid</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/GridSearchCV.html">GridSearchCV</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  learner <span class="op">=</span> <span class="va">svm</span>,</span>
<span>  tune_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>    kernel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"polynomial"</span>, <span class="st">"radial"</span>, <span class="st">"sigmoid"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  learner_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"C-classification"</span>,</span>
<span>    probability <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  splitter <span class="op">=</span> <span class="va">splitter_fn</span>,</span>
<span>  scorer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    accuracy <span class="op">=</span> <span class="va">accuracy_vec</span>,</span>
<span>    f_measure <span class="op">=</span> <span class="va">f_meas_vec</span>,</span>
<span>    auc <span class="op">=</span> <span class="va">roc_auc_vec</span></span>
<span>  <span class="op">)</span>,</span>
<span>  prediction_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    accuracy <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    f_measure <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    auc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>probability <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  convert_predictions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    accuracy <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    f_measure <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    auc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"probabilities"</span><span class="op">)</span><span class="op">[</span>, <span class="st">"FALSE"</span><span class="op">]</span></span>
<span>  <span class="op">)</span>,</span>
<span>  optimize_score <span class="op">=</span> <span class="st">"max"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now that we’ve specified our Grid Search schema let’s check out the
hyper-parameter grid and see how many models we’re going to
estimate.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"We will estimate"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">iris_grid</span><span class="op">$</span><span class="va">tune_params</span><span class="op">)</span>, <span class="st">"SVM models\n"</span><span class="op">)</span></span>
<span><span class="co"># We will estimate 18 SVM models</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="launch-aws-resources">Launch AWS Resources<a class="anchor" aria-label="anchor" href="#launch-aws-resources"></a>
</h2>
<p>To speed up the estimation of our models, let’s create a remote
cluster of 6 worker nodes to estimate the models in parallel.</p>
<div class="section level3">
<h3 id="launch-ec2-instances">Launch EC2 Instances<a class="anchor" aria-label="anchor" href="#launch-ec2-instances"></a>
</h3>
<p>First, we will launch 6 instances using a custom AMI that contains R
and a bunch of essential R packages. While this AMI is not available as
a community AMI there are definitely good AMIs out there that have a
comprehensive set of R packages and corresponding tools installed.
<strong>Note:</strong> which parameters you need to specify when
launching EC2 instances may vary greatly depending on your account’s
security configurations.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ec2_client</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paws-r.r-universe.dev/paws/reference/ec2.html" class="external-link">ec2</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Request Instances</span></span>
<span><span class="va">instance_req</span> <span class="op">&lt;-</span> <span class="va">ec2_client</span><span class="op">$</span><span class="fu">run_instances</span><span class="op">(</span></span>
<span>  ImageId <span class="op">=</span> <span class="st">"ami-06dd49fc9e3a5acee"</span>,</span>
<span>  InstanceType <span class="op">=</span> <span class="st">"t2.large"</span>,</span>
<span>  KeyName <span class="op">=</span> <span class="va">key_name</span>,</span>
<span>  MaxCount <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  MinCount <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  InstanceInitiatedShutdownBehavior <span class="op">=</span> <span class="st">"terminate"</span>,</span>
<span>  SecurityGroupIds <span class="op">=</span> <span class="va">security_group</span>,</span>
<span>  <span class="co"># This names the instances</span></span>
<span>  TagSpecifications <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      ResourceType <span class="op">=</span> <span class="st">"instance"</span>,</span>
<span>      Tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          Key <span class="op">=</span> <span class="st">"Name"</span>,</span>
<span>          Value <span class="op">=</span> <span class="st">"Worker Node"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now that we’ve launched the instances we need to wait until they all
respond as <code>"running"</code> before we try to do anything (We also
need to wait for ~ 1 minute for the instances to initialize or they’ll
reject our SSH login attempts).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Chalk up a quick function to return instance IDs from our request</span></span>
<span><span class="va">instance_ids</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">response</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">response</span><span class="op">$</span><span class="va">Instances</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">i</span><span class="op">$</span><span class="va">InstanceId</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Wait for instances to all respond as 'running'</span></span>
<span><span class="kw">while</span><span class="op">(</span></span>
<span>  <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>      <span class="va">ec2_client</span><span class="op">$</span></span>
<span>      <span class="fu">describe_instances</span><span class="op">(</span>InstanceIds <span class="op">=</span> <span class="fu">instance_ids</span><span class="op">(</span><span class="va">instance_req</span><span class="op">)</span><span class="op">)</span><span class="op">$</span></span>
<span>      <span class="va">Reservations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span></span>
<span>      <span class="va">Instances</span>,</span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">i</span><span class="op">$</span><span class="va">State</span><span class="op">$</span><span class="va">Name</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">==</span> <span class="st">"running"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Rough heuristic -- give additional 45 seconds for instances to initialize</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">45</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-cluster">Create Cluster<a class="anchor" aria-label="anchor" href="#create-cluster"></a>
</h3>
<p>Now, in order to set up our compute cluster we need to get the IP
addresses from these instances.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get public IPs</span></span>
<span><span class="va">inst_public_ips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>  <span class="va">ec2_client</span><span class="op">$</span></span>
<span>    <span class="fu">describe_instances</span><span class="op">(</span>InstanceIds <span class="op">=</span> <span class="fu">instance_ids</span><span class="op">(</span><span class="va">instance_req</span><span class="op">)</span><span class="op">)</span><span class="op">$</span></span>
<span>    <span class="va">Reservations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span></span>
<span>    <span class="va">Instances</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="va">i</span><span class="op">$</span><span class="va">PublicIpAddress</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can create a compute cluster on these worker nodes via
SSH.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parallelly.futureverse.org/reference/makeClusterPSOCK.html" class="external-link">makeClusterPSOCK</a></span><span class="op">(</span></span>
<span>  worker <span class="op">=</span> <span class="va">inst_public_ips</span>,</span>
<span>  user <span class="op">=</span> <span class="st">"ubuntu"</span>,</span>
<span>  rshopts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"-o"</span>, <span class="st">"StrictHostKeyChecking=no"</span>,</span>
<span>              <span class="st">"-o"</span>, <span class="st">"IdentitiesOnly=yes"</span>,</span>
<span>              <span class="st">"-i"</span>, <span class="va">pem_fp</span><span class="op">)</span>, <span class="co"># Local filepath to private SSH key-pair</span></span>
<span>  connectTimeout <span class="op">=</span> <span class="fl">25</span>,</span>
<span>  tries <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="estimate-models">Estimate Models<a class="anchor" aria-label="anchor" href="#estimate-models"></a>
</h2>
<p>Now that we’ve created our compute cluster, we can use the
<code>future</code> package to specify our parallelization plan. Since
<code>modeltuning</code> is built on top of the <code>future</code>
framework, it will automatically parallelize the model estimation across
our 6-worker cluster. The following parallelization
<strong>topology</strong> basically is telling <code>future</code> to
parallelize the grid-search models across the compute cluster, and to
parallelize each model’s cross-validation across the cores of the
instance it is being evaluated on.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">cl</span><span class="op">)</span>,</span>
<span>    <span class="va">multisession</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Finally, let’s estimate our Grid Search models in parallel!</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iris_grid_fitted</span> <span class="op">&lt;-</span> <span class="va">iris_grid</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">Species</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>  data <span class="op">=</span> <span class="va">iris_new</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="best-modelparameters">Best Model/Parameters<a class="anchor" aria-label="anchor" href="#best-modelparameters"></a>
</h2>
<p>Let’s check out the info on our best model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best_idx</span> <span class="op">&lt;-</span> <span class="va">iris_grid_fitted</span><span class="op">$</span><span class="va">best_idx</span></span>
<span><span class="va">metrics</span> <span class="op">&lt;-</span> <span class="va">iris_grid_fitted</span><span class="op">$</span><span class="va">metrics</span></span>
<span></span>
<span><span class="co"># Print model metrics of best model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="st">" Accuracy:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">metrics</span><span class="op">$</span><span class="va">accuracy</span><span class="op">[[</span><span class="va">best_idx</span><span class="op">]</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="st">"%\nF-Measure:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">metrics</span><span class="op">$</span><span class="va">f_measure</span><span class="op">[[</span><span class="va">best_idx</span><span class="op">]</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="st">"%\n      AUC:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">metrics</span><span class="op">$</span><span class="va">auc</span><span class="op">[[</span><span class="va">best_idx</span><span class="op">]</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#  Accuracy: 98.4 %</span></span>
<span><span class="co"># F-Measure: 98.81 %</span></span>
<span><span class="co">#       AUC: 0.9993</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="va">iris_grid_fitted</span><span class="op">$</span><span class="va">best_params</span></span>
<span></span>
<span><span class="co"># Print the best hyper-parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="st">"  Optimal Cost:"</span>, <span class="va">params</span><span class="op">[[</span><span class="st">"cost"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="st">"\nOptimal Kernel:"</span>, <span class="va">params</span><span class="op">[[</span><span class="st">"kernel"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"\n"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#   Optimal Cost: 6 </span></span>
<span><span class="co"># Optimal Kernel: polynomial</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="kill-aws-resources">Kill AWS Resources<a class="anchor" aria-label="anchor" href="#kill-aws-resources"></a>
</h2>
<p>Now that we’ve completed our mini-analysis let’s make sure to kill
all our AWS resources. Since all we’ve done is launch EC2 instances, all
this consists of is making sure that the instances are all shut
down.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ec2_client</span><span class="op">$</span><span class="fu">stop_instances</span><span class="op">(</span></span>
<span>  InstanceIds <span class="op">=</span> <span class="fu">instance_ids</span><span class="op">(</span><span class="va">instance_req</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel Molitor.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
